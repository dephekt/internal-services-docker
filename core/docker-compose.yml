services:
  newt:
    build:
      context: .
      dockerfile: newt.Dockerfile
    image: local/newt:latest
    container_name: newt
    restart: unless-stopped
    env_file:
      - config.env
    environment:
      - DOCKER_SOCKET=/run/docker.sock
      - DOCKER_ENFORCE_NETWORK_VALIDATION=true
      - HEALTH_FILE=/tmp/newt-health
    volumes:
      - /run/docker.sock:/run/docker.sock:ro
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/newt-health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    secrets:
      - NEWT_ID.env
      - NEWT_SECRET.env
    entrypoint: ["/usr/local/bin/secrets2env.sh", "/entrypoint.sh"]
    command: ["newt"]

  auth:
    build:
      context: .
      dockerfile: keycloak.Dockerfile
    image: local/keycloak:26.3-providers
    container_name: auth
    env_file:
      - config.env
    environment:
      - KC_PROXY=edge
      - KC_HOSTNAME=https://auth.${DOMAIN}
      - KC_HOSTNAME_BACKCHANNEL_DYNAMIC=true
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_HTTP_ENABLED=true
      - KC_PROXY_HEADERS=xforwarded
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/9000 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "pangolin.proxy-resources.auth.name=Keycloak"
      - "pangolin.proxy-resources.auth.protocol=http"
      - "pangolin.proxy-resources.auth.full-domain=auth.${DOMAIN}"
      - "pangolin.proxy-resources.auth.targets[0].method=http"
      - "pangolin.proxy-resources.auth.targets[0].port=8080"
    secrets:
      - KEYCLOAK_ADMIN_PASSWORD.env
      - KC_DB_PASSWORD.env
    entrypoint: ["/usr/local/bin/secrets2env.sh", "/opt/keycloak/bin/kc.sh"]
    command: ["start"]
    volumes:
      - keycloak-data:/opt/keycloak/data
    depends_on:
      db:
        condition: service_healthy

  db:
    image: mariadb:11.4
    container_name: keycloak-db
    restart: unless-stopped
    env_file:
      - config.env
    environment:
      - MARIADB_DATABASE=keycloak
      - MARIADB_USER=${KC_DB_USERNAME}
      - MARIADB_PASSWORD_FILE=/run/secrets/db_password
      - MARIADB_ROOT_PASSWORD_FILE=/run/secrets/mariadb_root_password
    healthcheck:
      test: ["CMD-SHELL", "mariadb -ukeycloak -p\"$$(cat /run/secrets/db_password)\" --database=keycloak --execute=\"SELECT 1\""]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    volumes:
      - keycloak-mariadb:/var/lib/mysql
    secrets:
      - db_password
      - mariadb_root_password

volumes:
  keycloak-data:
  keycloak-mariadb:

secrets:
  KEYCLOAK_ADMIN_PASSWORD.env:
    file: ./secrets/KEYCLOAK_ADMIN_PASSWORD.env
  KC_DB_PASSWORD.env:
    file: ./secrets/DB_PASSWORD.env
  db_password:
    file: ./secrets/DB_PASSWORD.env
  mariadb_root_password:
    file: ./secrets/MARIADB_ROOT_PASSWORD
  NEWT_ID.env:
    file: ./secrets/NEWT_ID.env
  NEWT_SECRET.env:
    file: ./secrets/NEWT_SECRET.env
